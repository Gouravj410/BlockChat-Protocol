<!DOCTYPE html>
<html>
<head>
    <title>BlockChat Login Debugging Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #0f0;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin: 20px 0 10px 0; color: #0ff; }
        h2 { margin: 15px 0 8px 0; font-size: 1.1em; color: #0f0; }
        .log {
            background: #1a1a1a;
            border: 1px solid #333;
            border-left: 3px solid #0f0;
            padding: 8px;
            margin: 5px 0;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log.error { border-left-color: #f00; }
        .log.warning { border-left-color: #ff0; }
        .log.success { border-left-color: #0f0; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px 10px 0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        button:hover { background: #0f0; opacity: 0.8; }
        .section { margin: 20px 0; }
        .result-box {
            background: #1a1a1a;
            border: 2px solid #0ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        textarea {
            width: 100%;
            height: 200px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç BlockChat Login Debug Tool</h1>
        <p>Use this page to test and diagnose the login flow issue.</p>

        <div class="section">
            <h2>Step 1: Verify Backend</h2>
            <button onclick="testBackends()">Test Backend Health & Login</button>
            <div id="backendLog" class="log"></div>
        </div>

        <div class="section">
            <h2>Step 2: Check Frontend Resources</h2>
            <button onclick="checkFrontendFiles()">Check script.js & HTML Structure</button>
            <div id="frontendLog" class="log"></div>
        </div>

        <div class="section">
            <h2>Step 3: Monitor Live Login Flow</h2>
            <button onclick="startMonitoring()">Start Monitoring Background Tab</button>
            <p><small>Open http://localhost:8000 in another tab, try to login there, check console below</small></p>
            <div id="monitorLog" class="log"></div>
        </div>

        <div class="section">
            <h2>Step 4: Detailed Response Analysis</h2>
            <button onclick="analyzeLoginResponse()">Analyze Full Login Response</button>
            <div id="analysisLog" class="log"></div>
            <textarea id="responseBody" placeholder="Response will appear here"></textarea>
        </div>

        <div class="section">
            <h2>üß™ Test Results Summary</h2>
            <div id="summary" class="result-box">
                <p>Run the tests above to generate a summary...</p>
            </div>
        </div>
    </div>

    <script>
        const logs = {
            backend: [],
            frontend: [],
            monitor: [],
            analysis: []
        };

        function addLog(section, message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const msg = `[${time}] ${message}`;
            logs[section].push(msg);
            const elem = document.getElementById(section + 'Log');
            if (elem) {
                const div = document.createElement('div');
                div.className = type;
                div.textContent = msg;
                elem.appendChild(div);
                elem.scrollTop = elem.scrollHeight;
            }
            console.log(`[${section.toUpperCase()}]`, msg);
        }

        async function testBackends() {
            document.getElementById('backendLog').innerHTML = '';
            logs.backend = [];
            
            try {
                addLog('backend', 'üîç Testing backend...', 'info');
                
                // Health check
                const health = await fetch('http://localhost:5000/api/health');
                addLog('backend', `Health check: ${health.status}`, health.ok ? 'success' : 'error');
                
                // Test login
                addLog('backend', 'Sending login request...', 'info');
                const loginResp = await fetch('http://localhost:5000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'user@example.com', password: 'password123' })
                });
                
                addLog('backend', `Login response: ${loginResp.status} ${loginResp.statusText}`, loginResp.ok ? 'success' : 'error');
                
                const data = await loginResp.json();
                addLog('backend', `success field: ${data.success}`, data.success ? 'success' : 'error');
                addLog('backend', `user field: ${data.user?.name || 'missing'}`, data.user ? 'success' : 'error');
                addLog('backend', `flowSteps: ${data.flowSteps?.length || 0} steps`, data.flowSteps?.length > 0 ? 'success' : 'warning');
                
                addLog('backend', '‚úÖ Backend test complete!', 'success');
            } catch (e) {
                addLog('backend', `‚ùå Error: ${e.message}`, 'error');
            }
        }

        async function checkFrontendFiles() {
            document.getElementById('frontendLog').innerHTML = '';
            logs.frontend = [];
            
            try {
                addLog('frontend', 'Fetching script.js...', 'info');
                const scriptResp = await fetch('http://localhost:8000/script.js');
                const scriptText = await scriptResp.text();
                
                const checks = [
                    {name: 'showPage function', regex: /function showPage/},
                    {name: 'animateLoginFlow function', regex: /async function animateLoginFlow/},
                    {name: 'localStorage usage', regex: /localStorage\./},
                    {name: 'data.success check', regex: /if\s*\(\s*data\.success\s*\)/},
                    {name: 'handleLogin function', regex: /function handleLogin/},
                ];
                
                checks.forEach(check => {
                    const found = check.regex.test(scriptText);
                    addLog('frontend', `${check.name}: ${found ? '‚úÖ' : '‚ùå'}`, found ? 'success' : 'error');
                });
                
                addLog('frontend', '‚úÖ File check complete!', 'success');
            } catch (e) {
                addLog('frontend', `‚ùå Error: ${e.message}`, 'error');
            }
        }

        async function analyzeLoginResponse() {
            document.getElementById('analysisLog').innerHTML = '';
            document.getElementById('responseBody').value = '';
            logs.analysis = [];
            
            try {
               addLog('analysis', 'Fetching login response...', 'info');
                const resp = await fetch('http://localhost:5000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'user@example.com', password: 'password123' })
                });
                
                const data = await resp.json();
                document.getElementById('responseBody').value = JSON.stringify(data, null, 2);
                
                addLog('analysis', `Response type: ${typeof data}`, 'success');
                addLog('analysis', `success type: ${typeof data.success}, value: ${data.success}`, 'success');
                addLog('analysis', `Boolean check (data.success === true): ${data.success === true}`, data.success === true ? 'success' : 'error');
                addLog('analysis', `Truthy check (if data.success): ${!!data.success}`, !!data.success ? 'success' : 'error');
                addLog('analysis', `User object present: ${!!data.user}`, !!data.user ? 'success' : 'error');
                addLog('analysis', `FlowSteps array: ${data.flowSteps?.length || 0} items`, data.flowSteps?.length > 0 ? 'success' : 'warning');
                
                if (data.flowSteps && Array.isArray(data.flowSteps)) {
                    addLog('analysis', `First step: ${data.flowSteps[0]?.step}/${data.flowSteps[0]?.status}`, 'info');
                    addLog('analysis', `Last step: ${data.flowSteps[data.flowSteps.length-1]?.step}/${data.flowSteps[data.flowSteps.length-1]?.status}`, 'info');
                }
                
                addLog('analysis', '‚úÖ Analysis complete!', 'success');
            } catch (e) {
                addLog('analysis', `‚ùå Error: ${e.message}`, 'error');
            }
        }

        function startMonitoring() {
            document.getElementById('monitorLog').innerHTML = '';
            logs.monitor = [];
            addLog('monitor', 'üì° Live monitoring enabled. This page will watch for messages from the main site...', 'info');
            addLog('monitor', '‚ö†Ô∏è  Use browser DevTools ‚Üí Application ‚Üí Storage ‚Üí Local Storage ‚Üí http://localhost:8000 to manually watch localStorage changes', 'warning');
            
            // Watch for localStorage changes in background
            window.addEventListener('storage', (e) => {
                if (e.key && e.key.includes('log')) {
                    addLog('monitor', `üîî localStorage changed: ${e.key} = ${e.newValue}`, 'success');
                }
            });
            
            addLog('monitor', 'Ready to monitor. Refresh this tip if you don\'t see changes.', 'info');
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            console.log('%cüîç Login Debug Tool Ready!', 'color: #0f0; font-size: 16px; font-weight: bold;');
        });
    </script>
</body>
</html>
